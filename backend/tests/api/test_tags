from fastapi.testclient import TestClient

from app import schemas


def test_tags(client: TestClient, superuser_headers: dict[str, str]):
    names = ["foo", "bar", "baz"]

    # create tags
    for name in names:
        r = client.post("/tags", json=dict(name=name), headers=superuser_headers)
        data = r.json()
        assert r.status_code == 201, data

    tag_id = data["id"]

    # get all tags using db (no auth needed)
    r = client.get("/tags/")
    data = r.json()
    assert r.status_code == 200, data
    assert len(data) == len(names)

    # get one tag by name
    r = client.get(f"/tags/{names[-1]}")
    data = r.json()
    assert r.status_code == 200, data
    assert data["name"] == names[-1]

    # patch a tag
    r = client.patch(
        f"/tags/{tag_id}", json=dict(color_code="ffffff"), headers=superuser_headers
    )
    data = r.json()
    assert r.status_code == 200, data
    assert data["color_code"] == "ffffff"

    # delete a tag, and check it's not there
    r = client.delete(f"/tags/{tag_id}", headers=superuser_headers)
    assert r.status_code == 204, r.status_code
    r = client.get(f"/tags/{tag_id}")
    assert r.status_code == 404, r.status_code
